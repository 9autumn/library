# 🚀 青山区图书馆后端服务 - 启动指南

## 📋 准备工作

### 1. 安装MySQL

#### 方式1：使用XAMPP（推荐，简单）
1. 下载XAMPP：https://www.apachefriends.org/
2. 安装后启动 **MySQL** 服务
3. 默认用户名：`root`，密码：空（或按安装时设置）

#### 方式2：安装MySQL官方版本
1. 下载MySQL：https://dev.mysql.com/downloads/mysql/
2. 安装并配置
3. 记住设置的root密码

### 2. 检查MySQL是否运行

打开MySQL客户端或使用XAMPP控制面板检查MySQL状态。

## 🗄️ 创建数据库

### 方式1：使用初始化脚本（推荐）

```bash
# 如果MySQL已添加到PATH
mysql -u root -p < init_mysql.sql
# 输入密码：ww1014917211

# 如果使用XAMPP，找到mysql.exe路径（通常在 C:\xampp\mysql\bin\）
C:\xampp\mysql\bin\mysql.exe -u root -p < init_mysql.sql
```

### 方式2：手动创建

1. 打开MySQL命令行或工具（如Navicat、phpMyAdmin）

```sql
-- 创建数据库
CREATE DATABASE ai_library 
  CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 查看数据库
SHOW DATABASES;
```

2. **注意**：表结构会在首次启动后端时自动创建，无需手动创建！

## 🔧 配置后端

### 1. 更新 .env 文件

确保 `.env` 文件中的数据库配置正确：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=ww1014917211
DB_NAME=ai_library
```

### 2. 安装Python依赖

```bash
# 激活虚拟环境（如果还没创建）
python -m venv venv
venv\Scripts\activate

# 安装依赖（使用国内镜像加速）
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

## ▶️ 启动后端服务

### 方式1：使用启动脚本（推荐）

```bash
start.bat
```

### 方式2：手动启动

```bash
# 确保虚拟环境已激活
venv\Scripts\activate

# 启动服务
python app/main.py
```

### 方式3：使用uvicorn命令

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## ✅ 验证服务

服务启动后，你会看到：

```
============================================================
🚀 启动 青山区图书馆后端服务 v1.0.0
📝 环境: development
🐛 调试模式: 开启
============================================================
✅ MySQL 连接成功: localhost:3306
📊 使用数据库: ai_library
✅ 数据库表创建成功
✅ 服务启动成功！
📚 API文档: http://0.0.0.0:8000/docs
📖 ReDoc: http://0.0.0.0:8000/redoc
============================================================
```

### 访问以下地址验证：

1. **API文档**: http://localhost:8000/docs
2. **健康检查**: http://localhost:8000/health
3. **根路径**: http://localhost:8000/

## 🧪 测试API

### 在浏览器中测试

访问 http://localhost:8000/docs，使用Swagger UI测试接口：

1. **注册游客**
   - 点击 `POST /api/v1/visitors/register`
   - 点击 "Try it out"
   - 填写信息：
     ```json
     {
       "username": "testuser",
       "email": "test@example.com",
       "password": "123456",
       "name": "测试用户",
       "phone": "13800138000"
     }
     ```
   - 点击 "Execute"

2. **登录**
   - 点击 `POST /api/v1/visitors/login`
   - 填写：
     ```json
     {
       "username": "testuser",
       "password": "123456"
     }
     ```
   - 复制返回的 `access_token`

3. **获取用户信息**
   - 点击 `GET /api/v1/visitors/me`
   - 点击右上角 "Authorize" 按钮
   - 输入：`Bearer <你的token>`
   - 执行请求

### 使用curl测试

```bash
# 注册
curl -X POST http://localhost:8000/api/v1/visitors/register ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"test001\",\"email\":\"test@example.com\",\"password\":\"123456\"}"

# 登录
curl -X POST http://localhost:8000/api/v1/visitors/login ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"test001\",\"password\":\"123456\"}"
```

## ❓ 常见问题

### 问题1：MySQL连接失败
```
❌ MySQL 连接失败
```
**解决方案**：
- 检查MySQL服务是否启动
- 验证 `.env` 中的数据库配置
- 确认数据库 `ai_library` 已创建

### 问题2：端口被占用
```
Address already in use
```
**解决方案**：
- 修改 `.env` 中的 `PORT=8000` 为其他端口（如8001）

### 问题3：导入错误
```
ModuleNotFoundError
```
**解决方案**：
- 确保虚拟环境已激活
- 重新安装依赖：`pip install -r requirements.txt`

### 问题4：数据库密码错误
```
Access denied for user 'root'
```
**解决方案**：
- 检查 `.env` 中的 `DB_PASSWORD` 是否正确
- 当前配置：`DB_PASSWORD=ww1014917211`

## 📊 数据库管理

### 查看表结构

```sql
USE ai_library;
DESCRIBE visitors;
```

### 查看数据

```sql
SELECT * FROM visitors;
```

### 清空表数据（慎用）

```sql
TRUNCATE TABLE visitors;
```

## 🎉 启动成功标志

看到以下输出即表示启动成功：

✅ MySQL 连接成功  
✅ 数据库表创建成功  
✅ 服务启动成功  
📚 可以访问API文档

现在可以开始使用了！

